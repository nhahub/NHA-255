pipeline {
    agent {
        kubernetes {
            yaml '''
                apiVersion: v1
                kind: Pod
                metadata:
                    name: jenkins-agent-pod
                    labels:
                        app: jenkins-agent
                spec:
                    containers:
                        -   name: git
                            image: alpine/git:latest
                            command:
                                - sleep
                            args:
                                - 99d
                            tty: true

                        -   name: kaniko
                            image: gcr.io/kaniko-project/executor:debug
                            command:
                                - /busybox/sleep
                            args:
                                - 99999
                            tty: true

                        -   name: mailer
                            image: alpine:latest
                            command:
                                - sleep
                            args:
                                - 99d
                            tty: true
            '''
        }
    }
    environment {
        GIT_REPO = 'https://github.com/nhahub/NHA-255.git'
        GIT_BRANCH = 'main'
        DOCKER_IMAGE = 'mohamedelsayed22/petclinic-depi'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        K8S_NAMESPACE = 'default'
    }
    stages {
        stage('Checkout') {
            steps {
                container('git') {
                    git branch: 'main', url: 'https://github.com/nhahub/NHA-255.git'
                }
            }
        }
        stage('Build docker image and push to docker hub') {
            steps {
                withCredentials([usernamePassword(
                            credentialsId: 'dockerhub',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )]) {
                            container('kaniko') {
                        sh """
                        cat > /kaniko/.docker/config.json <<EOF
                        {
                            "auths": {
                                        "https://index.docker.io/v1/": {
                                            "auth": "\$(echo -n $DOCKER_USER:$DOCKER_PASS | base64 | tr '\n')"
                                        }
                            }
                        }
                        EOF
                        /kaniko/executor \
                            --context `pwd`/java-app \
                            --dockerfile `pwd`/java-app/Dockerfile \
                            --destination $DOCKER_IMAGE:$DOCKER_TAG \
                            --destination $DOCKER_IMAGE:latest \
                            --cache=true \
                            --verbosity=info \
                            --snapshot-mode=redo
                    """
                            }
                        }
            }
        }

        stage('Send Email') {
            steps {
                container('mailer') {
                    withCredentials([usernamePassword(credentialsId: 'gmail', usernameVariable: 'GMAIL_USER', passwordVariable: 'GMAIL_PASS')]) {
                        sh """
                    apk add --no-cache curl ca-certificates

                    FROM="mohamedelsayedhussein22@gmail.com"
                    TO="mohamedelsayedhussein22@gmail.com"
                    SUBJECT="Jenkins Build #\\$BUILD_NUMBER - PetClinic Docker Image"
                    BODY="Jenkins Pipeline Execution Summary\\\\n\\\\nJob Name: \\$JOB_NAME\\\\nBuild Number: \\$BUILD_NUMBER\\\\nBuild URL: \\$BUILD_URL\\\\nStatus: SUCCESS\\\\n\\\\nDocker Images Built:\\\\n- $DOCKER_IMAGE:\\$BUILD_NUMBER\\\\n- $DOCKER_IMAGE:latest\\\\n\\\\nGit Repository: $GIT_REPO\\\\nGit Branch: $GIT_BRANCH\\\\n\\\\nNamespace: $K8S_NAMESPACE"

                    echo "Sending email..."
                    echo -e "From: \$FROM\\nTo: \$TO\\nSubject: \$SUBJECT\\n\\n\$BODY" > /tmp/email.txt

                    curl --url "smtps://smtp.gmail.com:465" \
                         --ssl-reqd \
                         --mail-from "\$FROM" \
                         --mail-rcpt "\$TO" \
                         --upload-file /tmp/email.txt \
                         --user "\$GMAIL_USER:\$GMAIL_PASS" \
                         --verbose
                """
                    }
                }
            }
        }
    }
}