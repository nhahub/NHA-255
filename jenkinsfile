pipeline {
    agent {
        kubernetes {
            yaml '''
                apiVersion: v1
                kind: Pod
                metadata:
                    name: jenkins-agent-pod
                    labels:
                        app: jenkins-agent
                spec:
                    containers:
                        -   name: git
                            image: alpine/git:latest
                            command:
                                - sleep
                            args:
                                - 99d
                            tty: true

                        -   name: kaniko
                            image: gcr.io/kaniko-project/executor:debug
                            command:
                                - /busybox/sleep
                            args:
                                - 99999
                            tty: true

                        -   name: trivy
                            image: aquasec/trivy:latest
                            command:
                                - sleep
                            args:
                                - 99d
                            tty: true

                        -   name: mailer
                            image: alpine:latest
                            command:
                                - sleep
                            args:
                                - 99d
                            tty: true
            '''
        }
    }
    environment {
        GIT_REPO = 'https://github.com/nhahub/NHA-255.git'
        GIT_BRANCH = 'main'
        DOCKER_IMAGE = 'mohamedelsayed22/petclinic-depi'
        DOCKER_TAG = "v1.${env.BUILD_NUMBER}"
    }
    stages {
        stage('Checkout') {
            steps {
                container('git') {
                    git branch: 'main', url: 'https://github.com/nhahub/NHA-255.git'
                }
            }
        }

        
    stage('Build docker image and push to docker hub') {
            steps {
                withCredentials([usernamePassword(
                            credentialsId: 'dockerhub',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )]) {
                            container('kaniko') {
                        sh """
                        AUTH_STRING=\$(echo -n \$DOCKER_USER:\$DOCKER_PASS | base64 | tr -d '\n')
                        
                        cat > /kaniko/.docker/config.json <<EOF
                        {
                            "auths": {
                                        "https://index.docker.io/v1/": {
                                            "auth": "\$AUTH_STRING"
                                        }
                            }
                        }
EOF
                        # 2. تنفيذ Kaniko
                        /kaniko/executor \\
                            --context `pwd`/app-CI \\
                            --dockerfile `pwd`/app-CI/Dockerfile \\
                            --destination $DOCKER_IMAGE:$DOCKER_TAG \\
                            --destination $DOCKER_IMAGE:latest \\
                            --cache=true \\
                            --verbosity=info \\
                            --snapshot-mode=redo
                    """
                            }
                        }
            }
        }

    stage('Trivy Vulnerability Scanner') {
                steps {
                    container('trivy') { 
                        sh """
                        echo "Starting Trivy scan on image: $DOCKER_IMAGE:$DOCKER_TAG"
                        trivy image \\
                            --ignore-unfixed \\
                            --severity CRITICAL \\
                            --format template --template '@default' \\
                            $DOCKER_IMAGE:$DOCKER_TAG
                        """
                    }
                }
            }



 

    }
    post {
        success {
            container('mailer') {
                withCredentials([usernamePassword(credentialsId: 'gmail', usernameVariable: 'GMAIL_USER', passwordVariable: 'GMAIL_PASS')]) {
                   sh """
                    apk update && apk add --no-cache curl ca-certificates
                    
                    FROM="awsconsolet@gmail.com"
                    TO="awsconsolet@gmail.com"
                    SUBJECT="SUCCESS: Jenkins Build #\${BUILD_NUMBER} - PetClinic Docker Image"
                    
                    echo "Sending email..."
                    echo -e "From: \$FROM\\nTo: \$TO\\nSubject: \$SUBJECT\\n\\n" > /tmp/email.txt
                    
                    cat >> /tmp/email.txt <<END_BODY
                    Jenkins Pipeline Execution Summary
                    
                    Job Name: \${JOB_NAME}
                    Build Number: \${BUILD_NUMBER}
                    Build URL: \${BUILD_URL}
                    Status: SUCCESS 
                    
                    Docker Images Built:
                    - ${DOCKER_IMAGE}:\${BUILD_NUMBER}
                    - ${DOCKER_IMAGE}:latest
                    
                    Git Repository: ${GIT_REPO}
                    Git Branch: ${GIT_BRANCH}
                    END_BODY

                    curl --url "smtps://smtp.gmail.com:465" \\
                         --ssl-reqd \\
                         --mail-from "\$FROM" \\
                         --mail-rcpt "\$TO" \\
                         --upload-file /tmp/email.txt \\
                         --user "\$GMAIL_USER:\$GMAIL_PASS" \\
                         --verbose
                    """
                }
            }
        }
        failure {
            container('mailer') {
                withCredentials([usernamePassword(credentialsId: 'gmail', usernameVariable: 'GMAIL_USER', passwordVariable: 'GMAIL_PASS')]) {
                   sh """
                    apk update && apk add --no-cache curl ca-certificates
                    
                    FROM="awsconsolet@gmail.com"
                    TO="awsconsolet@gmail.com"
                    SUBJECT="FAILURE: Jenkins Build #\${BUILD_NUMBER} - PetClinic Docker Image"
                    
                    echo "Sending email..."
                    echo -e "From: \$FROM\\nTo: \$TO\\nSubject: \$SUBJECT\\n\\n" > /tmp/email.txt
                    
                    cat >> /tmp/email.txt <<END_BODY
                    Jenkins Pipeline Execution Summary
                    
                    Job Name: \${JOB_NAME}
                    Build Number: \${BUILD_NUMBER}
                    Build URL: \${BUILD_URL}
                    Status: FAILED 
                    
                    Docker Images Built:
                    - ${DOCKER_IMAGE}:\${BUILD_NUMBER}
                    - ${DOCKER_IMAGE}:latest
                    
                    Git Repository: ${GIT_REPO}
                    Git Branch: ${GIT_BRANCH}
                    END_BODY

                    curl --url "smtps://smtp.gmail.com:465" \\
                         --ssl-reqd \\
                         --mail-from "\$FROM" \\
                         --mail-rcpt "\$TO" \\
                         --upload-file /tmp/email.txt \\
                         --user "\$GMAIL_USER:\$GMAIL_PASS" \\
                         --verbose
                    """
                }
            }
        }
    }
}





        // update the image tag
        // stage ('K8S Update Imgae tag'){
        //     steps {
        //         container('git') {
        // /////////////////////// with credentials text  //////////////////////////
        //             git branch: 'main', url: 'https://github.com/nhahub/NHA-255.git'
        //             sh '''
        //             cd NHA-255.git
        //             git checkout -b feature-$BRANCH_NAME
        //             sed -i "s#youssefmahdy/pet-clinic-amd64:v1#mohamedelsayed22/petclinic-depi:$DOCKER_TAG#" app-CD/k8s/pet-clinic-deploy.yaml
        //             cat app-CD/k8s/pet-clinic-deploy.yaml

        //             ###  Commit and push to Feature Branch  
        //             git config --global user.email "${GITHUB_EMAIL}"
        //             git config --global user.name "${GITHUB_USER}"
        //             git remote set-url origin https://${Git_TOKEN}@github.com/nhahub/NHA-255.git
        //             git add .
        //             git commit -m "Update image tag"
        //             git push origin feature-$BRANCH_NAME'
        //             '''
        //         }


        // ################# make PR #####################
        //   stage('Make PR') {
        //     steps {
        //         container('mailer') {
        //             withCredentials([usernamePassword(credentialsId: 'github', usernameVariable: 'GITHUB_USER', passwordVariable: 'GITHUB_PASS')]) {
        //                 sh """
        //             apk add --no-cache curl ca-certificates
        //             curl --url "https://api.github.com/repos/nhahub/NHA-255/pulls" \
        //                  --ssl-reqd \
        //                  --user "\$GITHUB_USER:\$GITHUB_PASS" \
        //                  --data '{"title": "Update image tag", "body": "Update image tag", "head": "feature-$BRANCH_NAME", "base": "main"}' \
        //                  --verbose   
        //         """
        //             }
        //         }
        //     }
        // }





        //     }
        // }




